# 日志管理

# 1、系统日志管理

```sh
#安装服务
[root@Rocky8 ~]#yum -y install rsyslog
```

## 1.1、**系统日志术语**

facility：设施，从功能或程序上对日志进行归类

```sh
#内置分类
auth, authpriv, cron, daemon,ftp,kern, lpr, mail, news, security(auth),
user, uucp, syslog
#自定义的分类
local0-local7
```

Priority 优先级别，从低到高排序

```sh
debug,info, notice, warn(warning), err(error), crit(critical), alert,
emerg(panic)
```

参看帮助： man 3 syslog，man logger

```sh
[root@centos8 ~]#yum -y install man-pages
[root@centos8 ~]#man 3 syslog
```

## 1.2、 **rsyslog** **相关文件**

```sh
程序包：rsyslog
主程序：/usr/sbin/rsyslogd
CentOS 6：/etc/rc.d/init.d/rsyslog {start|stop|restart|status}
CentOS 7,8：/usr/lib/systemd/system/rsyslog.service
配置文件：/etc/rsyslog.conf，/etc/rsyslog.d/*.conf
库文件： /lib64/rsyslog/*.so
```

## 1.3、**rsyslog**配置文件

**/etc/rsyslog.conf** **配置文件格式**：由三部分组成

```
MODULES：相关模块配置
GLOBAL DIRECTIVES：全局配置
RULES：日志记录相关的规则配置
```

**RULES**配置格式：

```
facility.priority; facility.priority… target
```

**facility**格式：

```
* #所有的facility
facility1,facility2,facility3,... #指定的facility列表
```

**priority**格式：

```
*: 所有级别
none：没有级别，即不记录
PRIORITY：指定级别（含）以上的所有级别
=PRIORITY：仅记录指定级别的日志信息
```

**target**格式：

```
文件路径：通常在/var/log/，文件路径前的-表示异步写入
用户：将日志事件通知给指定的用户，* 表示登录的所有用户
日志服务器：@host，把日志送往至指定的远程UDP日志服务器 @@host 将日志发送到远程TCP日志服务器
管道： | COMMAND，转发给其它命令处理
```

**通常的日志文件的格式：**

日志文件有很多，如： /var/log/messages,cron,secure等，基本格式都是类似的。格式如下

```
事件产生的日期时间 主机 进程(pid)：事件内容
```

范例：日志文件格式

```sh
[root@Rocky8 ~]#tail -f /var/log/messages 
Aug 15 10:46:09 Rocky8 systemd[1607]: Reached target Timers.
Aug 15 10:46:09 Rocky8 systemd[1607]: Starting D-Bus User Message Bus Socket.
Aug 15 10:46:09 Rocky8 systemd[1607]: Reached target Paths.
Aug 15 10:46:09 Rocky8 systemd[1607]: Listening on D-Bus User Message Bus Socket.
Aug 15 10:46:09 Rocky8 systemd[1607]: Reached target Sockets.
Aug 15 10:46:09 Rocky8 systemd[1607]: Reached target Basic System.
Aug 15 10:46:09 Rocky8 systemd[1607]: Reached target Default.
Aug 15 10:46:09 Rocky8 systemd[1607]: Startup finished in 38ms.
Aug 15 10:46:09 Rocky8 systemd[1]: Started User Manager for UID 0.
Aug 15 10:46:09 Rocky8 systemd[1]: Started Session 1 of user root.
Aug 15 10:46:29 Rocky8 systemd-logind[1031]: New session 3 of user root.
Aug 15 10:46:29 Rocky8 systemd[1]: Started Session 3 of user root.
...

[root@Rocky8 ~]#tail -f /var/log/secure 
Aug 15 10:09:03 Rocky8 sshd[1008]: Server listening on :: port 22.
Aug 15 10:09:03 Rocky8 polkitd[990]: Loading rules from directory /etc/polkit-1/rules.d
Aug 15 10:09:03 Rocky8 polkitd[990]: Loading rules from directory /usr/share/polkit-1/rules.d
Aug 15 10:09:03 Rocky8 polkitd[990]: Finished loading, compiling and executing 3 rules
Aug 15 10:09:03 Rocky8 polkitd[990]: Acquired the name org.freedesktop.PolicyKit1 on the system bus
Aug 15 10:46:09 Rocky8 sshd[1603]: Accepted password for root from 192.168.188.99 port 61162 ssh2
Aug 15 10:46:09 Rocky8 systemd[1607]: pam_unix(systemd-user:session): session opened for user root by (uid=0)
Aug 15 10:46:09 Rocky8 sshd[1603]: pam_unix(sshd:session): session opened for user root by (uid=0)
Aug 15 10:46:29 Rocky8 sshd[1653]: Accepted password for root from 192.168.188.99 port 61171 ssh2
Aug 15 10:46:29 Rocky8 sshd[1653]: pam_unix(sshd:session): session opened for user root by (uid=0)
```

范例：将ssh服务的日志记录至自定义的local的日志设备

```sh
#修改sshd服务的配置
[root@syslog-server ~]#vim /etc/ssh/sshd_config 

35 # Logging
 36 #SyslogFacility AUTH
 37 #SyslogFacility AUTHPRIV
 38 SyslogFacility LOCAL6
 39 #LogLevel INFO

[root@syslog-server ~]#systemctl restart sshd.service 

#修改rsyslog的配置
[root@syslog-server ~]# Vim /etc/rsyslog.conf

Local6.*     /var/log/sshd.log

[root@syslog-server ~]# systemctl restart sshd.service 

#测试
Ssh登录后，查看/var/log/sshd.log有记录

#logger测试
logger -p local2.info "hello sshd"
tail /var/log/sshd.log有记录
```

## 1.4、**启用网络日志服务**

启用网络日志服务功能，可以将多个远程主机的日志，发送到集中的日志服务器，方便统一管理

### 1、syslog-server配置

```sh
#CentOS 8 启用网络日志功能
[root@syslog-server ~]# Vim /etc/rsyslog.conf

//tcp端口
   module(load="imtcp")      //自带模块，取消注释即可
   input(type="imtcp" port="514")
   local6.*            /var/log/sshd.log

//udp端口
  module(load="imudp") # needs to be done just once
  input(type="imudp" port="514")

[root@syslog-server ~]#systemctl restart rsyslog.service 

#修改ssh配置文件
[root@syslog-server ~]#vim /etc/ssh/sshd_config 

SyslogFacility LOCAL6

[root@syslog-server ~]#systemctl restart sshd.service

```

### 2、客户端配置

```
#修改rsyslog配置
[root@postgers ~]# vim /etc/rsyslog.d/test.conf 

local6.*       /var/log/sshd.log
local6.*       @@192.168.188.82:514   #tcp端口
local6.*       @192.168.188.82:514    #udp端口

[root@postgers ~]# systemctl restart rsyslog.service 

#修改ssh配置文件
[root@postgers ~]# vim /etc/ssh/sshd_config

SyslogFacility LOCAL6

[root@postgers ~]# systemctl restart sshd.service
```

## 1.5、常见的日志文件

```
/var/log/secure：系统安全日志，文本格式，应周期性分析
/var/log/btmp：当前系统上，用户的失败尝试登录相关的日志信息，二进制格式，lastb命令进行
查看
/var/log/wtmp：当前系统上，用户正常登录系统的相关日志信息，二进制格式，last命令可以查看
/var/log/lastlog:每一个用户最近一次的登录信息，二进制格式，lastlog命令可以查看
/var/log/dmesg：CentOS7 之前版本系统引导过程中的日志信息，文本格式，开机后的硬件变化
将不再记录，也可以通过专用命令dmesg查看，可持续记录硬件变化的情况
/var/log/boot.log 系统服务启动的相关信息，文本格式
/var/log/messages ：系统中大部分的信息
/var/log/anaconda : anaconda的日志
```

### 范例1：找到失败登录的IP

```
[root@syslog-server log]#awk '/Failed password/{print $(NF-3)}' /var/log/sshd.log 
192.168.188.20
192.168.188.20
192.168.188.20
192.168.188.20
192.168.188.20
192.168.188.20
192.168.188.88
192.168.188.88
192.168.188.88
```

### 范例2：找出失败登录次数最多的前10个IP

```
[root@centos8 ~]#lastb -f btmp-test1 | awk '{print $3}'|sort | uniq -c|sort -nr|head
8374 112.64.33.38
7041 221.125.235.4
6502 183.247.184.220
5970 203.190.163.125
5297 202.89.0.27
3062 119.163.122.32
2961 124.126.248.6
2921 92.222.1.40
2896 112.65.170.186
1955 118.97.213.118
[root@centos8 ~]#lastb -f btmp-test2 | awk '{ip[$3]++}END{for(i in ip){print ip[i],i}}'|sort -nr|head
86294 58.218.92.37
43148 58.218.92.26
18036 112.85.42.201
10501 111.26.195.101
10501 111.231.235.49
10501 111.204.186.207
10501 111.11.29.199
10499 118.26.23.225
6288 42.7.26.142
4236 58.218.92.30
```

## 1.6、日志管理工具journalctl

CentOS 7 以后版，利用Systemd 统一管理所有 Unit 的启动日志。带来的好处就是，可以只用

journalctl一个命令，查看所有日志（内核日志和应用日志）。

**日志的配置文件：**

```
/etc/systemd/journald.conf
```

**journalctl****命令格式**

```
journalctl [OPTIONS...] [MATCHES...]
```

**选项说明：**

```sh
--no-full, --full, -l
如果字段内容超长则以省略号(...)截断以适应列宽。
默认显示完整的字段内容(超长的部分换行显示或者被分页工具截断)。
老旧的 -l/--full 选项 仅用于撤销已有的 --no-full 选项，除此之外没有其他用处。
-a, --all
完整显示所有字段内容， 即使其中包含不可打印字符或者字段内容超长。
-f, --follow
只显示最新的日志项，并且不断显示新生成的日志项。 此选项隐含了 -n 选项。
-e, --pager-end
在分页工具内立即跳转到日志的尾部。 此选项隐含了 -n1000
以确保分页工具不必缓存太多的日志行。 不过这个隐含的行数可以被明确设置的 -n
选项覆盖。 注意，此选项仅可用于 less(1) 分页器。
-n, --lines=
限制显示最新的日志行数。 --pager-end 与 --follow 隐含了此选项。
此选项的参数：若为正整数则表示最大行数； 若为 "all" 则表示不限制行数；
若不设参数则表示默认值10行。
--no-tail
显示所有日志行， 也就是用于撤销已有的 --lines= 选项(即使与 -f 连用)。
-r, --reverse
反转日志行的输出顺序， 也就是最先显示最新的日志。
-o, --output=
控制日志的输出格式。 可以使用如下选项：
short
这是默认值， 其输出格式与传统的 syslog[1] 文件的格式相似， 每条日志一行。
short-iso
与 short 类似，只是将时间戳字段以 ISO 8601 格式显示。
short-precise
与 short 类似，只是将时间戳字段的秒数精确到微秒级别。
short-monotonic
与 short 类似，只是将时间戳字段的零值从内核启动时开始计算。
short-unix
与 short 类似，只是将时间戳字段显示为从"UNIX时间原点"(1970-1-1 00:00:00
UTC)以来的秒数。 精确到微秒级别。
verbose
以结构化的格式显示每条日志的所有字段。
export
将日志序列化为二进制字节流(大部分依然是文本) 以适用于备份与网络传输(详见
Journal Export Format[2] 文档)。
json
将日志项按照JSON数据结构格式化， 每条日志一行(详见 Journal JSON Format[3]
文档)。
json-pretty
将日志项按照JSON数据结构格式化， 但是每个字段一行， 以便于人类阅读。
json-sse
将日志项按照JSON数据结构格式化，每条日志一行，但是用大括号包围， 以适应
Server-Sent Events[4] 的要求。
cat
仅显示日志的实际内容， 而不显示与此日志相关的任何元数据(包括时间戳)。
--utc
以世界统一时间(UTC)表示时间
--no-hostname
不显示来源于本机的日志消息的主机名字段。 此选项仅对 short
系列输出格式(见上文)有效。
-x, --catalog
在日志的输出中增加一些解释性的短文本， 以帮助进一步说明日志的含义、
问题的解决方案、支持论坛、 开发文档、以及其他任何内容。
并非所有日志都有这些额外的帮助文本， 详见 Message Catalog Developer
Documentation[5] 文档。
注意，如果要将日志输出用于bug报告， 请不要使用此选项。
-q, --quiet
当以普通用户身份运行时， 不显示任何警告信息与提示信息。 例如："-- Logs begin at
...", "-- Reboot --"
-m, --merge
混合显示包括远程日志在内的所有可见日志。
-b [ID][±offset], --boot=[ID][±offset]
显示特定于某次启动的日志， 这相当于添加了一个 "_BOOT_ID=" 匹配条件。
如果参数为空(也就是 ID 与 ±offset 都未指定)， 则表示仅显示本次启动的日志。
如果省略了 ID ， 那么当 ±offset 是正数的时候， 将从日志头开始正向查找，
否则(也就是为负数或零)将从日志尾开始反响查找。 举例来说， "-b
1"表示按时间顺序排列最早的那次启动， "-b 2"则表示在时间上第二早的那次启动； "-b
-0"表示最后一次启动， "-b -1"表示在时间上第二近的那次启动， 以此类推。 如果
±offset 也省略了， 那么相当于"-b -0"， 除非本次启动不是最后一次启动(例如用
--directory 指定了另外一台主机上的日志目录)。
如果指定了32字符的 ID ， 那么表示以此 ID 所代表的那次启动为基准
计算偏移量(±offset)， 计算方法同上。 换句话说， 省略 ID 表示以本次启动为基准
计算偏移量(±offset)。
--list-boots
列出每次启动的 序号(也就是相对于本次启动的偏移量)、32字符的ID、
第一条日志的时间戳、最后一条日志的时间戳。
-k, --dmesg
仅显示内核日志。隐含了 -b 选项以及 "_TRANSPORT=kernel" 匹配项。
-t, --identifier=SYSLOG_IDENTIFIER
仅显示 syslog[1] 识别符为 SYSLOG_IDENTIFIER 的日志项。
可以多次使用该选项以指定多个识别符。
-u, --unit=UNIT|PATTERN
仅显示属于特定单元的日志。 也就是单元名称正好等于 UNIT 或者符合 PATTERN
模式的单元。 这相当于添加了一个 "_SYSTEMD_UNIT=UNIT" 匹配项(对于 UNIT 来说)，
或一组匹配项(对于 PATTERN 来说)。
可以多次使用此选项以添加多个并列的匹配条件(相当于用"OR"逻辑连接)。
--user-unit=
仅显示属于特定用户会话单元的日志。 相当于同时添加了 "_SYSTEMD_USER_UNIT=" 与
"_UID=" 两个匹配条件。
可以多次使用此选项以添加多个并列的匹配条件(相当于用"OR"逻辑连接)。
-p, --priority=
根据日志等级(包括等级范围)过滤输出结果。 日志等级数字与其名称之间的对应关系如下
(参见 syslog(3))： "emerg" (0), "alert" (1), "crit" (2), "err" (3),
"warning" (4), "notice" (5), "info" (6), "debug" (7) 。
若设为一个单独的数字或日志等级名称， 则表示仅显示小于或等于此等级的日志
(也就是重要程度等于或高于此等级的日志)。 若使用 FROM..TO.. 设置一个范围，
则表示仅显示指定的等级范围内(含两端)的日志。 此选项相当于添加了 "PRIORITY="
匹配条件。
-c, --cursor=
从指定的游标(cursor)开始显示日志。
[提示]每条日志都有一个"__CURSOR"字段，类似于该条日志的指纹。
--after-cursor=
从指定的游标(cursor)之后开始显示日志。 如果使用了 --show-cursor 选项，
则也会显示游标本身。
--show-cursor
在最后一条日志之后显示游标， 类似下面这样，以"--"开头：
-- cursor: s=0639...
游标的具体格式是私有的(也就是没有公开的规范)， 并且会变化。
-S, --since=, -U, --until=
显示晚于指定时间(--since=)的日志、显示早于指定时间(--until=)的日志。
参数的格式类似 "2012-10-30 18:17:16" 这样。 如果省略了"时:分:秒"部分，
则相当于设为 "00:00:00" 。 如果仅省略了"秒"的部分则相当于设为 ":00" 。
如果省略了"年-月-日"部分， 则相当于设为当前日期。 除了"年-月-日 时:分:秒"格式，
参数还可以进行如下设置： (1)设为 "yesterday", "today", "tomorrow"
以表示那一天的零点(00:00:00)。 (2)设为 "now" 以表示当前时间。
(3)可以在"年-月-日 时:分:秒"前加上 "-"(前移) 或 "+"(后移)
前缀以表示相对于当前时间的偏移。 关于时间与日期的详细规范， 参见
systemd.time(7)
-F, --field=
显示所有日志中某个字段的所有可能值。 [译者注]类似于SQL语句："SELECT DISTINCT
某字段 FROM 全部日志"
-N, --fields
输出所有日志字段的名称
--system, --user
仅显示系统服务与内核的日志(--system)、 仅显示当前用户的日志(--user)。
如果两个选项都未指定，则显示当前用户的所有可见日志。
-M, --machine=
显示来自于正在运行的、特定名称的本地容器的日志。 参数必须是一个本地容器的名称。
-D DIR, --directory=DIR
仅显示来自于特定目录中的日志， 而不是默认的运行时和系统日志目录中的日志。
--file=GLOB
GLOB 是一个可以包含"?"与"*"的文件路径匹配模式。 表示仅显示来自与指定的 GLOB
模式匹配的文件中的日志， 而不是默认的运行时和系统日志目录中的日志。
可以多次使用此选项以指定多个匹配模式(多个模式之间用"OR"逻辑连接)。
--root=ROOT
在对日志进行操作时， 将 ROOT 视为系统的根目录。 例如 --update-catalog 将会创建
ROOT/var/lib/systemd/catalog/database
--new-id128
此选项并不用于显示日志内容， 而是用于重新生成一个标识日志分类的 128-bit ID 。
此选项的目的在于 帮助开发者生成易于辨别的日志消息， 以方便调试。
--header
此选项并不用于显示日志内容， 而是用于显示日志文件内部的头信息(类似于元数据)。
--disk-usage
此选项并不用于显示日志内容，
而是用于显示所有日志文件(归档文件与活动文件)的磁盘占用总量。
--vacuum-size=, --vacuum-time=, --vacuum-files=
这些选项并不用于显示日志内容，
而是用于清理日志归档文件(并不清理活动的日志文件)， 以释放磁盘空间。
--vacuum-size= 可用于限制归档文件的最大磁盘使用量 (可以使用 "K", "M", "G", "T"
后缀)； --vacuum-time= 可用于清除指定时间之前的归档 (可以使用 "s", "m", "h",
"days", "weeks", "months", "years" 后缀)； --vacuum-files=
可用于限制日志归档文件的最大数量。 注意，--vacuum-size= 对 --disk-usage
的输出仅有间接效果， 因为 --disk-usage 输出的是归档日志与活动日志的总量。
同样，--vacuum-files= 也未必一定会减少日志文件的总数，
因为它同样仅作用于归档文件而不会删除活动的日志文件。
此三个选项可以同时使用，以同时从三个维度去限制归档文件。
若将某选项设为零，则表示取消此选项的限制。
--list-catalog [128-bit-ID...]
简要列出日志分类信息， 其中包括对分类信息的简要描述。
如果明确指定了分类ID(128-bit-ID)， 那么仅显示指定的分类。
--dump-catalog [128-bit-ID...]
详细列出日志分类信息 (格式与 .catalog 文件相同)。
如果明确指定了分类ID(128-bit-ID)， 那么仅显示指定的分类。
--update-catalog
更新日志分类索引二进制文件。
每当安装、删除、更新了分类文件，都需要执行一次此动作。
--setup-keys
此选项并不用于显示日志内容， 而是用于生成一个新的FSS(Forward Secure
Sealing)密钥对。 此密钥对包含一个"sealing key"与一个"verification key"。
"sealing key"保存在本地日志目录中， 而"verification key"则必须保存在其他地方。
详见 journald.conf(5) 中的 Seal= 选项。
--force
与 --setup-keys 连用， 表示即使已经配置了FSS(Forward Secure Sealing)密钥对，
也要强制重新生成。
--interval=
与 --setup-keys 连用，指定"sealing key"的变化间隔。
较短的时间间隔会导致占用更多的CPU资源， 但是能够减少未检测的日志变化时间。
默认值是 15min
--verify
检查日志文件的内在一致性。 如果日志文件在生成时开启了FSS特性， 并且使用
--verify-key= 指定了FSS的"verification key"，
那么，同时还将验证日志文件的真实性。
--verify-key=
与 --verify 选项连用， 指定FSS的"verification key"
--sync
要求日志守护进程将所有未写入磁盘的日志数据刷写到磁盘上，
并且一直阻塞到刷写操作实际完成之后才返回。 因此该命令可以保证当它返回的时候，
所有在调用此命令的时间点之前的日志， 已经全部安全的刷写到了磁盘中。
--flush
要求日志守护进程 将 /run/log/journal 中的日志数据 刷写到 /var/log/journal 中
(如果持久存储设备当前可用的话)。 此操作会一直阻塞到操作完成之后才会返回，
因此可以确保在该命令返回时， 数据转移确实已经完成。
注意，此命令仅执行一个单独的、一次性的转移动作， 若没有数据需要转移，
则此命令什么也不做， 并且也会返回一个表示操作已正确完成的返回值。
--rotate
要求日志守护进程滚动日志文件。 此命令会一直阻塞到滚动完成之后才会返回。
-h, --help
显示简短的帮助信息并退出。
--version
显示简短的版本信息并退出。
--no-pager
不将程序的输出内容管道(pipe)给分页程序
```

### 实例：journalctl常见用法

```
#查看所有日志（默认情况下 ，只保存本次启动的日志）
journalctl
#查看内核日志（不显示应用日志）
journalctl -k
#查看系统本次启动的日志
journalctl -b
journalctl -b -0
#查看上一次启动的日志（需更改设置）
journalctl -b -1
#查看指定时间的日志
journalctl --since="2017-10-30 18:10:30"
journalctl --since "20 min ago"
journalctl --since yesterday
journalctl --since "2017-01-10" --until "2017-01-11 03:00"
journalctl --since 09:00 --until "1 hour ago"
#显示尾部的最新10行日志
journalctl -n
#显示尾部指定行数的日志
journalctl -n 20
#实时滚动显示最新日志
journalctl -f
#查看指定服务的日志
journalctl /usr/lib/systemd/systemd
#查看指定进程的日志
journalctl _PID=1
#查看某个路径的脚本的日志
journalctl /usr/bin/bash
#查看指定用户的日志
journalctl _UID=33 --since today
#查看某个 Unit 的日志
journalctl -u nginx.service
journalctl -u nginx.service --since today
#实时滚动显示某个 Unit 的最新日志
journalctl -u nginx.service -f
#合并显示多个 Unit 的日志
journalctl -u nginx.service -u php-fpm.service --since today
#查看指定优先级（及其以上级别）的日志，共有8级
0: emerg
1: alert
2: crit
3: err
4: warning
5: notice
6: info
7: debug
journalctl -p err -b
#日志默认分页输出，--no-pager 改为正常的标准输出
journalctl --no-pager
#日志管理journalctl
#以 JSON 格式（单行）输出
journalctl -b -u nginx.service -o json
#以 JSON 格式（多行）输出，可读性更好
journalctl -b -u nginx.service -o json-pretty
#显示日志占据的硬盘空间
journalctl --disk-usage
#指定日志文件占据的最大空间
journalctl --vacuum-size=1G
#指定日志文件保存多久
journalctl --vacuum-time=1years
```

## 1.7、**利用** **MySQL** **存储日志信息**

利用rsyslog日志服务，将收集的日志记录于MySQL中

```
环境准备：两台主机
一台：rsyslog日志服务器，IP：192.168.188.82
一台：MySQL数据库服务器，IP：192.168.188.83
```

### 1、实现步骤

#### ①rsyslog主机配置

```
#安装相关服务
[root@syslog-servercd ~]#yum install rsyslog rsyslog-mysql

[root@syslog-servercd ~]#rpm -ql rsyslog-mysql 
/usr/lib/.build-id
/usr/lib/.build-id/e6
/usr/lib/.build-id/e6/aa0e40c19a2e0524d72780eee3b1698684cbe7
/usr/lib64/rsyslog/ommysql.so
/usr/share/doc/rsyslog/mysql-createDB.sql

#查看sql文件脚本内容
[root@syslog-servercd ~]#cat /usr/share/doc/rsyslog/mysql-createDB.sql
CREATE DATABASE Syslog;
USE Syslog;
CREATE TABLE SystemEvents
(
        ID int unsigned not null auto_increment primary key,
        CustomerID bigint,
        ReceivedAt datetime NULL,
        DeviceReportedTime datetime NULL,
        Facility smallint NULL,
        Priority smallint NULL,
        FromHost varchar(60) NULL,
        Message text,
        NTSeverity int NULL,
        Importance int NULL,
        EventSource varchar(60),
        EventUser varchar(60) NULL,
        EventCategory int NULL,
        EventID int NULL,
        EventBinaryData text NULL,
        MaxAvailable int NULL,
        CurrUsage int NULL,
        MinUsage int NULL,
        MaxUsage int NULL,
        InfoUnitID int NULL ,
        SysLogTag varchar(60),
        EventLogType varchar(60),
        GenericFileName VarChar(60),
        SystemID int NULL
);

CREATE TABLE SystemEventsProperties
(
        ID int unsigned not null auto_increment primary key,
        SystemEventID int NULL ,
        ParamName varchar(255) NULL ,
        ParamValue text NULL
);

#复制sql文件到MySQL主机上
[root@syslog-servercd ~]#scp /usr/share/doc/rsyslog/mysql-createDB.sql 192.168.188.83:/data
#验证
[root@rsyslog-mysql ~]# ls /data/
mysql-createDB.sql
```

#### ②mysql服务器配置

```
#安装服务
[root@rsyslog-mysql ~]# yum -y install mysql-server
[root@rsyslog-mysql ~]# systemctl enable --now  mysqld.service 
#在mariadb数据库服务器上创建相关数据库和表，并授权rsyslog能连接至当前服务器
mysql> create user rsyslog@'192.168.188.%' identified by '123456';
Query OK, 0 rows affected (0.01 sec)

mysql> grant all on Syslog.* to rsyslog@'192.168.188.%';
Query OK, 0 rows affected (0.01 sec)
```

③**配置日志服务器将日志发送至指定数据库**

```
#配置rsyslog将日志保存到mysql中
#
####MODULES####
#在 MODULES 语言下面，如果是 CentOS 8 加下面行
module(load="ommysql")
#在 MODULES 语言下面，如果是 CentOS 7，6 加下面行
$ModLoad ommysql

#在RULES语句块加下面行的格式
 41 #### RULES ####

#facility.priority :ommysql:DBHOST,DBNAME,DBUSER, PASSWORD
 50 *.info;mail.none;authpriv.none;cron.none                :ommysql:192.168.188.83,Syslog,rsyslog,123456
 
 #重启服务
 [root@syslog-servercd ~]#systemctl restart rsyslog.service 
```

④测试

```
#rsyslog.20
[root@postgers ~]# logger 'i love shipanpan'
[root@postgers ~]# logger 'i AM UBUNTU'

##在日志服务器上生成日志
[root@syslog-servercd ~]#tail -f /var/log/messages 

Aug 16 08:33:00 postgers systemd[1]: Started System Logging Service.
Aug 16 08:33:00 postgers rsyslogd: rsyslogd's userid changed to 107
Aug 16 08:33:00 postgers rsyslogd: [origin software="rsyslogd" swVersion="8.2112.0" x-pid="5662" x-info="https://www.rsyslog.com"] start
Aug 16 08:33:25 postgers root: i love shipanpan
Aug 16 08:33:25 postgers root: i love shipanpan
Aug 16 08:34:31 postgers root: i AM UBUNTU
Aug 16 08:34:31 postgers root: i AM UBUNTU

#MySQL查看数据
[root@rsyslog-mysql ~]# mysql 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 12
Server version: 8.0.26 Source distribution

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> use Syslog
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+------------------------+
| Tables_in_Syslog       |
+------------------------+
| SystemEvents           |
| SystemEventsProperties |
+------------------------+
2 rows in set (0.00 sec)

mysql> select count(*) from SystemEvents where message like '%am%'\G;
*************************** 1. row ***************************
count(*): 4
1 row in set (0.01 sec)

ERROR: 
No query specified
```

```
rsyslog配置

*.info;mail.none;authpriv.none;cron.none                /var/log/messages
```



# 2、 **logrotate** **日志转储**



## **2.1 logrotate** **介绍**

logrotate 程序是一个日志文件管理工具。用来把旧的日志文件删除，并创建新的日志文件，称为日志转

储或滚动。可以根据日志文件的大小，也可以根据其天数来转储，这个过程一般通过 cron 程序来执行

## **2.2 logrotate** **配置**

软件包：logrotate

相关文件

计划任务：/etc/cron.daily/logrotate

程序文件：/usr/sbin/logrotate

配置文件： /etc/logrotate.conf

日志文件：/var/lib/logrotate/logrotate.status

```
[root@rsyslog-mysql ~]# rpm -ql logrotate 
/etc/cron.daily
/etc/cron.daily/logrotate
/etc/logrotate.conf
/etc/logrotate.d
/etc/logrotate.d/btmp
/etc/logrotate.d/wtmp
/etc/rwtab.d/logrotate
/usr/lib/.build-id
/usr/lib/.build-id/0e
/usr/lib/.build-id/0e/dd48ab54c5df23180d8380d8aa1a2aed05b031
/usr/sbin/logrotate
/usr/share/doc/logrotate
/usr/share/doc/logrotate/ChangeLog.md
/usr/share/licenses/logrotate
/usr/share/licenses/logrotate/COPYING
/usr/share/man/man5/logrotate.conf.5.gz
/usr/share/man/man8/logrotate.8.gz
/var/lib/logrotate
/var/lib/logrotate/logrotate.status
```

配置文件主要参数如下：

```
配置参数 说明
compress 通过gzip压缩转储以后的日志
nocompress 不压缩
copytruncate 用于还在打开中的日志文件，把当前日志备份并截断
nocopytruncate 备份日志文件但是不截断
create mode owner
group
转储文件，使用指定的权限，所有者，所属组创建新的日志文件
nocreate 不建立新的日志文件
delaycompress 和 compress 一起使用时，转储的日志文件到下一次转储时才压缩
nodelaycompress 覆盖 delaycompress 选项，转储同时压缩
errors address 专储时的错误信息发送到指定的Email 地址
ifempty 即使是空文件也转储，此为默认选项
notifempty 如果是空文件的话，不转储
mail address 把转储的日志文件发送到指定的E-mail 地址
nomail 转储时不发送日志文件
olddir directory 转储后的日志文件放入指定目录，必须和当前日志文件在同一个文件
系统
noolddir 转储后的日志文件和当前日志文件放在同一个目录下
prerotate/endscript 在转储以前需要执行的命令，这两个关键字必须单独成行
postrotate/endscript 在转储以后需要执行的命令，这两个关键字必须单独成行
daily 指定转储周期为每天
weekly 指定转储周期为每周
monthly 指定转储周期为每月
rotate count 指定日志文件删除之前转储的次数，0 指没有备份，5 指保留5 个备份
tabooext [+] list 让logrotate不转储指定扩展名的文件，缺省的扩展名是：.rpm-orig,
.rpmsave, v, 和 ~
size size 当日志文件到达指定的大小时才转储，bytes(缺省)及KB或MB
sharedscripts
默认，对每个转储日志运行prerotate和postrotate脚本，日志文件
的绝对路径作为第一个参数传递给脚本。 这意味着单个脚本可以针对
与多个文件匹配的日志文件条目多次运行（例如/ var / log / news /
*.example）。 如果指定此项sharedscripts，则无论有多少个日志
与通配符模式匹配，脚本都只会运行一次
nosharedscripts 针对每一个转储的日志文件，都执行一次prerotate 和 postrotate脚
本，此为默认值
配置参数 说明
missingok 如果日志不存在，不提示错误，继续处理下一个
nomissingok 如果日志不存在，提示错误，此为默认值

```

## **2.3 logroate** **配置范例**

**范例1： 设置nginx的日志转储**

```
cat /etc/logrotate.d/nginx
/var/log/nginx/*.log {
daily
rotate 100
missingok
compress
delaycompress
notifempty
create 644 ngnix nginx
postrotate
if [ -f /app/nginx/logs/nginx.pid ]; then
kill -USR1 `cat /app/nginx/logs/nginx.pid`
fi
endscript
}
```

**范例2：对指定日志手动执行日志转储**

```
[root@rsyslog-mysql ~]# dd if=/dev/zero of=/var/log/test1.log bs=2M count=1;
1+0 records in
1+0 records out
2097152 bytes (2.1 MB, 2.0 MiB) copied, 0.00145751 s, 1.4 GB/s
[root@rsyslog-mysql ~]# dd if=/dev/zero of=/var/log/test2.log bs=2M count=1;
1+0 records in
1+0 records out
2097152 bytes (2.1 MB, 2.0 MiB) copied, 0.00139551 s, 1.5 GB/s
[root@rsyslog-mysql ~]# ll /var/log/test*
-rw-r--r-- 1 root root 2097152 Aug 16 17:16 /var/log/test1.log
-rw-r--r-- 1 root root 2097152 Aug 16 17:17 /var/log/test2.log

[root@rsyslog-mysql ~]# vim /etc/logrotate.d/test1
[root@rsyslog-mysql ~]# cat /etc/logrotate.d/test1
/var/log/test1.log {
daily
rotate 5
compress
delaycompress
missingok
size 1M
notifempty
create 640 bin nobody
postrotate
echo `date +%F_%T` >> /data/test1.log
endscript
}


[root@rsyslog-mysql ~]# vim /etc/logrotate.d/test2
[root@rsyslog-mysql ~]# cat /etc/logrotate.d/test2
/var/log/test2.log {
daily
rotate 5
compress
delaycompress
missingok
size 1M
notifempty
create 644 root root
postrotate
echo `date +%F_%T` >> /data/test2.log
endscript
}

[root@rsyslog-mysql ~]# ls /etc/cron.daily/
logrotate
#对所有日志进行手动转储
[root@rsyslog-mysql ~]# logrotate /etc/logrotate.conf
[root@rsyslog-mysql ~]# ls /var/log/test*
/var/log/test1.log  /var/log/test1.log-20230816  /var/log/test2.log /var/log/test2.log-20230816


#对test1.log日志进行手动转储
[root@rsyslog-mysql ~]# dd if=/dev/zero of=/var/log/test1.log bs=2M count=1;
1+0 records in
1+0 records out
2097152 bytes (2.1 MB, 2.0 MiB) copied, 0.00155069 s, 1.4 GB/s
[root@rsyslog-mysql ~]# logrotate /etc/logrotate.d/test1 
[root@rsyslog-mysql ~]# ls /var/log/test* -l
-rw-r----- 1 bin  nobody       0 Aug 16 17:27 /var/log/test1.log
-rw-r----- 1 bin  nobody 2097152 Aug 16 17:27 /var/log/test1.log.1
-rw-r--r-- 1 root root   2097152 Aug 16 17:16 /var/log/test1.log-20230816
-rw-r----- 1 bin  nobody    2067 Aug 16 17:26 /var/log/test1.log.2.gz
-rw-r--r-- 1 root root         0 Aug 16 17:23 /var/log/test2.log
-rw-r--r-- 1 root root   2097152 Aug 16 17:17 /var/log/test2.log-20230816

```

# 3、网络文件共享服务

```
ls -d $PWD/*
```

## 3.1、存储类型：

```
直连式存储：Direct-Attached Storage，简称 DAS

存储区域网络：Storage Area Network，简称 SAN

网络附加存储：Network-Attached Storage，简称 NAS
```

## 3.2、NFS服务

### 3.2.1、NFS工作原理

```
NFS：Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用
户和程序可以像访问本地文件一样访问远端系统上的文件，基于RPC（Remote Procedure Call
Protocol 远程过程调用）实现
RPC采用C/S模式，客户机请求程序调用进程发送一个有进程参数的调用信息到服务进程，然后等待应答
信息。在服务器端，进程保持睡眠状态直到调用信息到达为止。当一个调用信息到达，服务器获得进程
参数，计算结果，发送答复信息，然后等待下一个调用信息，最后，客户端调用进程接收答复信息，获
得进程结果，然后调用执行继续进行

NFS优势：节省本地存储空间，将常用的数据,如：/home目录，存放在NFS服务器上且可以通过网络访
问，本地终端将可减少自身存储空间的使用
```





```shell
#server/client都需要安装ufs-utils


##server配置
[root@Rocky8 ~]#yum -y install nfs-utils
[root@rocky8 ~]# rpm -ql nfs-utils
/etc/exports.d
/etc/gssproxy/24-nfs-server.conf
/etc/modprobe.d/lockd.conf
/etc/nfs.conf
/etc/nfsmount.conf
/etc/request-key.d/id_resolver.conf
/sbin/mount.nfs
/sbin/mount.nfs4
/sbin/nfsdcltrack
/sbin/rpc.statd
/sbin/umount.nfs
/sbin/umount.nfs4
/usr/lib/.build-id
/usr/lib/.build-id/1c
/usr/lib/.build-id/1c/1877175cf9ed571718ad9c9d1ad05c88c79fbc
/usr/lib/.build-id/1d
/usr/lib/.build-id/1d/245903cd5b0e26cdc5a8addcc5fff2e0a0803a
/usr/lib/.build-id/1f
/usr/lib/.build-id/1f/efbcb608e33fa0cccc97c78f5b2fbaf1bbd27f
/usr/lib/.build-id/2e
/usr/lib/.build-id/2e/fd8820f5c65120719503390444ba5191cf611d
/usr/lib/.build-id/3e
/usr/lib/.build-id/3e/296983e1088bce5e4b528097a7813f71ea51c9
/usr/lib/.build-id/50
/usr/lib/.build-id/50/d24e314d7aeb44335c05350da5c919d071f8f4
/usr/lib/.build-id/57
/usr/lib/.build-id/57/ea01f10e0b991ee007c4429cabafff674f1772
/usr/lib/.build-id/7a
/usr/lib/.build-id/7a/5e85fb6e5196cf4fe43fd99ecf45267b1944e0
/usr/lib/.build-id/85
/usr/lib/.build-id/85/23f40bc0f4d0c2331ffb8c929d9de2fc90b0d1
/usr/lib/.build-id/89
/usr/lib/.build-id/89/5d78d34c94837a6558ae0a9f1f91840795b51f
/usr/lib/.build-id/8c
/usr/lib/.build-id/8c/942ca47f6201c25f8d24a044f98888144df7f9
/usr/lib/.build-id/91
/usr/lib/.build-id/91/1136d792f5bbb44abd57128c4d1a7b7104849b
/usr/lib/.build-id/93
/usr/lib/.build-id/93/955f4fde01b40bda3fe1c6f97e1af45f16fd1d
/usr/lib/.build-id/9b
/usr/lib/.build-id/9b/26e57788003d39468a0e9d176b290a24e259d6
/usr/lib/.build-id/bb
/usr/lib/.build-id/bb/7c6eff78f37107288f9c19783664693339e403
/usr/lib/.build-id/c2
/usr/lib/.build-id/c2/d0ea049afd64d9e263a8f3a829be3600cd730b
/usr/lib/.build-id/da
/usr/lib/.build-id/da/91d1e866d8efa418f32c739d21a239e0347f58
/usr/lib/.build-id/ec
/usr/lib/.build-id/ec/8b4bd2152fc234418ffb4b4619742541ac887d
/usr/lib/.build-id/f2
/usr/lib/.build-id/f2/e65883a1d9befa514088ff09e8725529de6499
/usr/lib/.build-id/fe
/usr/lib/.build-id/fe/22dedb5c04d68461345953dde8d22abdce5d91
/usr/lib/systemd/system-generators/nfs-server-generator
/usr/lib/systemd/system-generators/rpc-pipefs-generator
/usr/lib/systemd/system/auth-rpcgss-module.service
/usr/lib/systemd/system/nfs-blkmap.service
/usr/lib/systemd/system/nfs-client.target
/usr/lib/systemd/system/nfs-convert.service
/usr/lib/systemd/system/nfs-idmapd.service
/usr/lib/systemd/system/nfs-mountd.service
/usr/lib/systemd/system/nfs-server.service
/usr/lib/systemd/system/nfs-utils.service
/usr/lib/systemd/system/nfsdcld.service
/usr/lib/systemd/system/proc-fs-nfsd.mount
/usr/lib/systemd/system/rpc-gssd.service
/usr/lib/systemd/system/rpc-statd-notify.service
/usr/lib/systemd/system/rpc-statd.service
/usr/lib/systemd/system/rpc_pipefs.target
/usr/lib/systemd/system/var-lib-nfs-rpc_pipefs.mount
/usr/lib/udev/rules.d/99-nfs.rules
/usr/libexec/nfs-utils
/usr/libexec/nfs-utils/nfsconvert.sh
/usr/libexec/nfsrahead
/usr/sbin/blkmapd
/usr/sbin/exportfs
/usr/sbin/mountstats
/usr/sbin/nfsconf
/usr/sbin/nfsconvert
/usr/sbin/nfsdcld
/usr/sbin/nfsdclddb
/usr/sbin/nfsdclnts
/usr/sbin/nfsidmap
/usr/sbin/nfsiostat
/usr/sbin/nfsref
/usr/sbin/nfsstat
/usr/sbin/rpc.gssd
/usr/sbin/rpc.idmapd
/usr/sbin/rpc.mountd
/usr/sbin/rpc.nfsd
/usr/sbin/rpcctl
/usr/sbin/rpcdebug
/usr/sbin/showmount
/usr/sbin/sm-notify
/usr/sbin/start-statd
/usr/share/doc/nfs-utils
/usr/share/doc/nfs-utils/ChangeLog
/usr/share/doc/nfs-utils/KNOWNBUGS
/usr/share/doc/nfs-utils/NEW
/usr/share/doc/nfs-utils/README
/usr/share/doc/nfs-utils/THANKS
/usr/share/doc/nfs-utils/TODO
/usr/share/man/man3/nfs4_uid_to_name.3.gz
/usr/share/man/man5/exports.5.gz
/usr/share/man/man5/idmapd.conf.5.gz
/usr/share/man/man5/nfs.5.gz
/usr/share/man/man5/nfs.conf.5.gz
/usr/share/man/man5/nfsmount.conf.5.gz
/usr/share/man/man5/nfsrahead.5.gz
/usr/share/man/man7/nfs.systemd.7.gz
/usr/share/man/man7/nfsd.7.gz
/usr/share/man/man8/blkmapd.8.gz
/usr/share/man/man8/exportfs.8.gz
/usr/share/man/man8/gssd.8.gz
/usr/share/man/man8/idmapd.8.gz
/usr/share/man/man8/mount.nfs.8.gz
/usr/share/man/man8/mountd.8.gz
/usr/share/man/man8/mountstats.8.gz
/usr/share/man/man8/nfsconf.8.gz
/usr/share/man/man8/nfsd.8.gz
/usr/share/man/man8/nfsdcld.8.gz
/usr/share/man/man8/nfsdclddb.8.gz
/usr/share/man/man8/nfsdclnts.8.gz
/usr/share/man/man8/nfsdcltrack.8.gz
/usr/share/man/man8/nfsidmap.8.gz
/usr/share/man/man8/nfsiostat.8.gz
/usr/share/man/man8/nfsref.8.gz
/usr/share/man/man8/nfsstat.8.gz
/usr/share/man/man8/rpc.gssd.8.gz
/usr/share/man/man8/rpc.idmapd.8.gz
/usr/share/man/man8/rpc.mountd.8.gz
/usr/share/man/man8/rpc.nfsd.8.gz
/usr/share/man/man8/rpc.sm-notify.8.gz
/usr/share/man/man8/rpc.statd.8.gz
/usr/share/man/man8/rpcctl.8.gz
/usr/share/man/man8/rpcdebug.8.gz
/usr/share/man/man8/showmount.8.gz
/usr/share/man/man8/sm-notify.8.gz
/usr/share/man/man8/statd.8.gz
/usr/share/man/man8/umount.nfs.8.gz
/var/lib/nfs
/var/lib/nfs/etab
/var/lib/nfs/rmtab
/var/lib/nfs/rpc_pipefs
/var/lib/nfs/statd
/var/lib/nfs/statd/sm
/var/lib/nfs/statd/sm.bak
/var/lib/nfs/statd/state
/var/lib/nfs/v4recovery

[root@Rocky8 ~]#systemctl status rpcbind.socket 
● rpcbind.socket - RPCbind Server Activation Socket
   Loaded: loaded (/usr/lib/systemd/system/rpcbind.socket; enabled; vendor preset: enabled)
   Active: active (listening) since Wed 2023-08-23 22:34:20 CST; 2min 25s ago
   Listen: /run/rpcbind.sock (Stream)
           0.0.0.0:111 (Stream)
           0.0.0.0:111 (Datagram)
           [::]:111 (Stream)
           [::]:111 (Datagram)
    Tasks: 0 (limit: 11187)
   Memory: 0B
   CGroup: /system.slice/rpcbind.socket

Aug 23 22:34:20 Rocky8 systemd[1]: Listening on RPCbind Server Activation Socket.

[root@Rocky8 ~]#ss -ntlp
State           Recv-Q           Send-Q                     Local Address:Port                     Peer Address:Port          Process                                     

·······

LISTEN          0                128                                 [::]:111                              [::]:*              users:(("systemd",pid=1,fd=53))      


[root@Rocky8 ~]#rpcinfo -p     //查看打开的端口
   program vers proto   port  service
    100000    4   tcp    111  portmapper
    100000    3   tcp    111  portmapper
    100000    2   tcp    111  portmapper
    100000    4   udp    111  portmapper
    100000    3   udp    111  portmapper
    100000    2   udp    111  portmapper
    100024    1   udp  49482  status
    100024    1   tcp  38077  status
    100005    1   udp  20048  mountd
    100005    1   tcp  20048  mountd
    100005    2   udp  20048  mountd
    100005    2   tcp  20048  mountd
    100005    3   udp  20048  mountd
    100005    3   tcp  20048  mountd
    100003    3   tcp   2049  nfs
    100003    4   tcp   2049  nfs
    100227    3   tcp   2049  nfs_acl
    100021    1   udp  47637  nlockmgr
    100021    3   udp  47637  nlockmgr
    100021    4   udp  47637  nlockmgr
    100021    1   tcp  23443  nlockmgr
    100021    3   tcp  23443  nlockmgr
    100021    4   tcp  23443  nlockmgr


[root@Rocky8 ~]#mkdir /data/share1 -p
[root@Rocky8 ~]#mkdir /data/share2 -p
[root@Rocky8 ~]#ll /etc/exports
-rw-r--r--. 1 root root 0 Sep 10  2018 /etc/exports
[root@Rocky8 ~]#vim /etc/exports

/data/share1     *

[root@Rocky8 ~]#exportfs -r   //加载配置
exportfs: No options for /data/share1 *: suggest *(sync) to avoid warning
[root@Rocky8 ~]#exportfs -v
/data/share1  	<world>(sync,wdelay,hide,no_subtree_check,sec=sys,ro,secure,root_squash,no_all_squash)


#客户端配置
[root@Rocky8 ~]#yum -y install nfs-utils
[root@rocky8 ~]# showmount -e 192.168.188.8    //验证共享文件
Export list for 192.168.188.8:
/data/share1 *

[root@rocky8 ~]# mount 192.168.188.8:/data/share1 /data/nfs1

#验证
[root@rocky8 ~]# df -Th
Filesystem                 Type      Size  Used Avail Use% Mounted on
devtmpfs                   devtmpfs  1.8G     0  1.8G   0% /dev
tmpfs                      tmpfs     1.8G     0  1.8G   0% /dev/shm
tmpfs                      tmpfs     1.8G  9.0M  1.8G   1% /run
tmpfs                      tmpfs     1.8G     0  1.8G   0% /sys/fs/cgroup
/dev/mapper/rl-root        xfs       100G  6.2G   94G   7% /
/dev/nvme0n1p1             xfs       2.0G  199M  1.8G  10% /boot
/dev/mapper/rl-data        xfs        50G  777M   50G   2% /data
tmpfs                      tmpfs     364M     0  364M   0% /run/user/0
192.168.188.8:/data/share1 nfs4      100G   20G   81G  20% /data/nfs1
[root@rocky8 ~]# ls /data/nfs1/
a.txt  b.txt

```

### 3.2.2实现所用用户权限压缩为web（uid=6666）

```shell
#修改nfs-server配置文件
[root@Rocky8 ~]#vim /etc/exports

/data/share1     *(rw,all_squash,anonuid=6666,anongid=6666)
~                                                                     

#生效配置
[root@Rocky8 ~]#exportfs -r
[root@Rocky8 ~]#exportfs -v
/data/share1  	<world>(sync,wdelay,hide,no_subtree_check,anonuid=6666,anongid=6666,sec=sys,rw,secure,root_squash,all_squash)

#验证
[root@Ubuntu1804 ~]# touch /data/nfs1/web6666.txt
[root@Ubuntu1804 ~]# touch /data/nfs1/webid.txt
[root@Ubuntu1804 ~]# ls /data/nfs1/ -l
total 20
-rw-r--r-- 1 nobody nogroup    0 Aug 24 01:28 allsquash.txt
-rwxrwxrwx 1 root   root     859 Aug 23 23:10 a.txt
-rwxrwxrwx 1 root   root    1149 Aug 23 22:57 b.txt
-rw-r--r-- 1 nobody nogroup    6 Aug 23 23:12 c.txt
-rw-r--r-- 1    306     306    6 Aug 23 23:14 d.txt
-rw-r--r-- 1 nobody nogroup    6 Aug 24 00:50 e.txt
-rw-r--r-- 1    666     666    0 Aug 24 01:33 id666.txt
-rw-r--r-- 1 root   root       0 Aug 24 01:26 root.txt
-rw-r--r-- 1 web    web        0 Aug 24 01:34 web6666.txt
-rw-r--r-- 1 web    web        0 Aug 24 01:35 webid.txt


#实现特定主机制定权限
[root@Rocky8 ~]#vim /etc/exports

  1 /data/share1     *(rw,all_squash,anonuid=6666,anongid=6666)  192.168.188.88(ro)

[root@Rocky8 ~]#exportfs -v
/data/share1  	192.168.188.88(sync,wdelay,hide,no_subtree_check,sec=sys,ro,secure,root_squash,no_all_squash)
/data/share1  	<world>(sync,wdelay,hide,no_subtree_check,anonuid=6666,anongid=6666,sec=sys,rw,secure,root_squash,all_squash)

#验证192.168.188.88
[root@rocky8 ~]# showmount -e 192.168.188.8
Export list for 192.168.188.8:
/data/share1 (everyone)

#挂载文件
[root@rocky8 ~]# mount 192.168.188.8://data/share1   /data/nfs1/
allsquash.txt  a.txt          b.txt          c.txt          d.txt          e.txt          id666.txt      root.txt       web6666.txt    webid.txt      
[root@rocky8 ~]# mkdir /data/nfs2/; mount 192.168.188.8://data/share1   /data/nfs2/
[root@rocky8 ~]# ls /data/nfs2/ -l
total 20
-rw-r--r-- 1 nobody nobody    0 Aug 24 01:28 allsquash.txt
-rwxrwxrwx 1 root   root    859 Aug 23 23:10 a.txt
-rwxrwxrwx 1 root   root   1149 Aug 23 22:57 b.txt
-rw-r--r-- 1 nobody nobody    6 Aug 23 23:12 c.txt
-rw-r--r-- 1 mysql  msyql     6 Aug 23 23:14 d.txt
-rw-r--r-- 1 nobody nobody    6 Aug 24 00:50 e.txt
-rw-r--r-- 1    666    666    0 Aug 24 01:33 id666.txt
-rw-r--r-- 1 root   root      0 Aug 24 01:26 root.txt
-rw-r--r-- 1   6666   6666    0 Aug 24 01:34 web6666.txt
-rw-r--r-- 1   6666   6666    0 Aug 24 01:35 webid.txt
[root@rocky8 ~]# touch /data/nfs2/88ro.txt
touch: cannot touch '/data/nfs2/88ro.txt': Read-only file system


#实现多文件挂载
[root@Rocky8 ~]#vim /etc/exports
[root@Rocky8 ~]#cat /etc/exports
/data/share1     *(rw,all_squash,anonuid=6666,anongid=6666)  192.168.188.88(ro)
/data/share2     *(ro)
[root@Rocky8 ~]#exportfs -r
[root@Rocky8 ~]#exportfs -v
/data/share1  	192.168.188.88(sync,wdelay,hide,no_subtree_check,sec=sys,ro,secure,root_squash,no_all_squash)
/data/share1  	<world>(sync,wdelay,hide,no_subtree_check,anonuid=6666,anongid=6666,sec=sys,rw,secure,root_squash,all_squash)
/data/share2  	<world>(sync,wdelay,hide,no_subtree_check,sec=sys,ro,secure,root_squash,no_all_squash)

[root@Ubuntu1804 ~]# showmount -e 192.168.188.8
Export list for 192.168.188.8:
/data/share2 *
/data/share1 (everyone)

#暂停共享
[root@Rocky8 ~]#exportfs -au

#验证文件未共享
#[root@Ubuntu1804 ~]# showmount -e 192.168.188.8
Export list for 192.168.188.8:

#恢复共享
root@Rocky8 ~]#exportfs -a
```

#### #实现永久挂载

```
修改client配置文件
[root@Ubuntu1804 ~]# vim /etc/fstab 

192.168.188.8:/data/share1 /data/nfs1      nfs     defaults,_netdev 0      0  #添加此行，_netdev实现先进行网络检查再执行挂载

[root@Ubuntu1804 ~]# mount -a   //加载配置
[root@Ubuntu1804 ~]# df -Th
Filesystem                 Type      Size  Used Avail Use% Mounted on
udev                       devtmpfs  951M     0  951M   0% /dev
tmpfs                      tmpfs     197M   11M  187M   6% /run
/dev/sda1                  ext4       92G  3.2G   84G   4% /
tmpfs                      tmpfs     984M     0  984M   0% /dev/shm
tmpfs                      tmpfs     5.0M     0  5.0M   0% /run/lock
tmpfs                      tmpfs     984M     0  984M   0% /sys/fs/cgroup
/dev/sda2                  ext4      921M  151M  707M  18% /boot
/dev/sda6                  ext4       46G   28K   44G   1% /data
tmpfs                      tmpfs     197M     0  197M   0% /run/user/0
192.168.188.8:/data/share1 nfs4      100G   20G   81G  20% /data/nfs1
```

# 4、**数据的实时同步**

## 4.1、实时同步介绍

```shell
#inotify工具集成再kernel中
/*Centos*/
[root@Rocky8 ~]#grep -i inotify /boot/config-4.18.0-425.19.2.el8_7.x86_64 
CONFIG_INOTIFY_USER=y
[root@Rocky8 ~]#grep -i inotify /boot/config-4.18.0-425.3.1.el8.x86_64 
CONFIG_INOTIFY_USER=y
/*Ubuntu*/
[root@Ubuntu1804 ~]# grep -i INOTIFY /boot/config-4.15.0-212-generic 
CONFIG_INOTIFY_USER=y

#相关文件
[root@Rocky8 ~]#ls -l /proc/sys/fs/inotify/
total 0
-rw-r--r-- 1 root root 0 Aug 23 23:26 max_queued_events
-rw-r--r-- 1 root root 0 Aug 23 23:26 max_user_instances
-rw-r--r-- 1 root root 0 Aug 23 23:26 max_user_watches

#用来监控事件变化的数量及说明
[root@Rocky8 ~]#cat  /proc/sys/fs/inotify/max_queued_events 
16384
[root@Rocky8 ~]#cat  /proc/sys/fs/inotify/max_user_instances 
128
[root@Rocky8 ~]#cat  /proc/sys/fs/inotify/max_user_watches 
13320

max_queued_events：inotify 事件队列最大长度，如值太小会出现 Event Queue Overflow 错
误，默认值：16384, 生产环境建议调大,比如:327679
max_user_instances：每个用户创建inotify实例最大值，默认值：128
max_user_watches：可以监视的文件的总数量（inotifywait 单进程），默认值：8192,建议调大
```

### 4.1.1修改内核参数

```
[root@Rocky8 ~]#vim /etc/sysctl.conf   #添加以下两行

fs.inotify.max_queued_events = 66666
fs.inotify.max_user_watches = 100000

[root@Rocky8 ~]#sysctl -p
net.ipv4.ip_local_port_range = 20000 60000
net.ipv4.ip_forward = 1
net.nf_conntrack_max = 1000000
net.netfilter.nf_conntrack_tcp_timeout_established = 120
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
fs.inotify.max_queued_events = 66666
fs.inotify.max_user_watches = 100000
[root@Rocky8 ~]#cat /proc/sys/fs/inotify/*
66666
128
100000
```

## 4.2、inotify-tools工具

```
#安装inotify-tools工具，minimal版本镜像默认不安装
[root@Rocky8 ~]#yum -y install inotify-tools
[root@Rocky8 ~]#rpm -ql inotify-tools
/usr/bin/inotifywait
/usr/bin/inotifywatch
/usr/lib/.build-id
/usr/lib/.build-id/4c
/usr/lib/.build-id/4c/50cc665007b18f08fb28fd1664b4363e77c6bf
/usr/lib/.build-id/76
/usr/lib/.build-id/76/f0034d7ea71f1d0011c7f0a9ba5c45c11f592b
/usr/lib/.build-id/cf
/usr/lib/.build-id/cf/b094946e4a3255959143feecd88504a6687c24
/usr/lib64/libinotifytools.so.0
/usr/lib64/libinotifytools.so.0.4.1
/usr/share/doc/inotify-tools
/usr/share/doc/inotify-tools/AUTHORS
/usr/share/doc/inotify-tools/COPYING
/usr/share/doc/inotify-tools/ChangeLog
/usr/share/doc/inotify-tools/NEWS
/usr/share/doc/inotify-tools/README
/usr/share/man/man1/inotifywait.1.gz
/usr/share/man/man1/inotifywatch.1.gz

#开启inotifywait一次性监控，创建完成自动退出
[root@Rocky8 ~]#inotifywait /data/
Setting up watches.
Watches established.
/data/ CREATE hang.txt


#创建文件验证
[root@Rocky8 ~]#touch /data/hang.txt


#开启持续性监控  inotifywait -m
[root@Rocky8 ~]#inotifywait -m /data/
Setting up watches.
Watches established.
/data/ CREATE a.txt
/data/ OPEN a.txt
/data/ ATTRIB a.txt
/data/ CLOSE_WRITE,CLOSE a.txt
/data/ CREATE b.txt
/data/ OPEN b.txt
/data/ ATTRIB b.txt
/data/ CLOSE_WRITE,CLOSE b.txt
/data/ CREATE c.txt
/data/ OPEN c.txt
/data/ ATTRIB c.txt
/data/ CLOSE_WRITE,CLOSE c.txt
/data/ CREATE d.txt
/data/ OPEN d.txt
/data/ ATTRIB d.txt
/data/ CLOSE_WRITE,CLOSE d.txt
/data/ CREATE e.txt
/data/ OPEN e.txt
/data/ ATTRIB e.txt
/data/ CLOSE_WRITE,CLOSE e.txt
/data/ OPEN,ISDIR 
/data/ ACCESS,ISDIR 
/data/ ACCESS,ISDIR 
/data/ CLOSE_NOWRITE,CLOSE,ISDIR 
/data/ DELETE a.txt
/data/ DELETE b.txt
/data/ DELETE c.txt
/data/ DELETE d.txt
/data/ DELETE e.txt

#验证
[root@Rocky8 ~]#touch /data/a.txt
[root@Rocky8 ~]#touch /data/b.txt
[root@Rocky8 ~]#touch /data/c.txt
[root@Rocky8 ~]#touch /data/d.txt
[root@Rocky8 ~]#touch /data/e.txt
[root@Rocky8 ~]#rm -rf /data/*.txt
```

## 4.3、rsync服务

```shell
#基本介绍
rsync 常用于做为 linux系统下的数据镜像备份工具，实现远程同步，支持本地复制，或者与其他SSH、
rsync主机同步数据，支持增量备份，配合任务计划，rsync能实现定时或间隔同步，配合inotify或
sersync，可以实现触发式的实时数据同步软件包：rsync，rsync-daemon（CentOS 8）

rsync 格式：
服务文件：/usr/lib/systemd/system/rsyncd.service
配置文件：/etc/rsyncd.conf
端口：873/tcp

#Local:
rsync [OPTION...] SRC... [DEST]
#Access via remote shell:
Pull:
rsync [OPTION...] [USER@]HOST:SRC... [DEST]
Push:
rsync [OPTION...] SRC... [USER@]HOST:DEST
#Access via rsync daemon:
Pull:
rsync [OPTION...] [USER@]HOST::SRC... [DEST]
rsync [OPTION...] rsync://[USER@]HOST[:PORT]/SRC... [DEST]
Push:
rsync [OPTION...] SRC... [USER@]HOST::DEST
rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST
The ':' usages connect via remote shell, while '::' & 'rsync://' usages connect
to an rsync daemon, and require SRC or DEST to start with a module name.
```

 **rsync**有三种工作方式：

```shell
1. 本地文件系统上实现同步。命令行语法格式为上述"Local"段的格式。

2. 本地主机使用远程shell和远程主机通信。命令行语法格式为上述"Access via remote shell"段的格

式。

3. 本地主机通过网络套接字连接远程主机上的rsync daemon。命令行语法格式为上述"Access via

rsync daemon"段的格式。

前两者的本质是通过本地或远程shell，而第3种方式则是让远程主机上运行rsyncd服务，使其监听在一

个端口上，等待客户端的连接。

常见选项：
-v：显示rsync过程中详细信息。可以使用"-vvvv"获取更详细信息。
-P：显示文件传输的进度信息。(实际上"-P"="--partial --progress"，其中的"--progress"才是显
示进度信息的)。
-n --dry-run ：仅测试传输，而不实际传输。常和"-vvvv"配合使用来查看rsync是如何工作的。
-a --archive ：归档模式，表示递归传输并保持文件属性。等同于"-rtopgDl"。
-r --recursive：递归到目录中去。
-t --times：保持mtime属性。强烈建议任何时候都加上"-t"，否则目标文件mtime会设置为系统时间，导
致下次更新
：检查出mtime不同从而导致增量传输无效。
-o --owner：保持owner属性(属主)。
-g --group：保持group属性(属组)。
-p --perms：保持perms属性(权限，不包括特殊权限)。
-D ：是"--device --specials"选项的组合，即也拷贝设备文件和特殊文件。
-l --links：如果文件是软链接文件，则拷贝软链接本身而非软链接所指向的对象
-z ：传输时进行压缩提高效率
-R --relative：使用相对路径。意味着将命令行中指定的全路径而非路径最尾部的文件名发送给服务端，
包括它们的属性。用法见下文示例。
--size-only ：默认算法是检查文件大小和mtime不同的文件，使用此选项将只检查文件大小。
-u --update ：仅在源mtime比目标已存在文件的mtime新时才拷贝。注意，该选项是接收端判断的，不会
影响删除行为。
-d --dirs ：以不递归的方式拷贝目录本身。默认递归时，如果源为"dir1/file1"，则不会拷贝dir1
目录，使用该选项将拷贝dir1但不拷贝file1。
--max-size ：限制rsync传输的最大文件大小。可以使用单位后缀，还可以是一个小数值(例如："--
max-size=1.5m")
--min-size ：限制rsync传输的最小文件大小。这可以用于禁止传输小文件或那些垃圾文件。
--exclude ：指定排除规则来排除不需要传输的文件。
--delete ：以SRC为主，对DEST进行同步。多则删之，少则补之。注意"--delete"是在接收端执行
的，所以它是在
：exclude/include规则生效之后才执行的。
-b --backup ：对目标上已存在的文件做一个备份，备份的文件名后默认使用"~"做后缀。
--backup-dir：指定备份文件的保存路径。不指定时默认和待备份文件保存在同一目录下。
-e ：指定所要使用的远程shell程序，默认为ssh。
--port ：连接daemon时使用的端口号，默认为873端口。
--password-file：daemon模式时的密码文件，可以从中读取密码实现非交互式。注意，这不是远程shell
认证的密码，而是rsync模块认证的密码。
-W --whole-file：rsync将不再使用增量传输，而是全量传输。在网络带宽高于磁盘带宽时，该选项比增
量传输更高效。
--existing ：要求只更新目标端已存在的文件，目标端还不存在的文件不传输。注意，使用相对路径时如
果上层目录不存在也不会传输。
--ignore-existing：要求只更新目标端不存在的文件。和"--existing"结合使用有特殊功能，见下文示
例。
--remove-source-files：要求删除源端已经成功传输的文件
```



```shell
#下载rsync-tools工具
[root@backup ~]# yum -y install rsync-daemon

#修改配置文件
[root@backup-server ~]# vim /etc/rsyncd.conf 

uid = root
gid = root
max connections = 0 
ignore errors
exclude = lost+found/
log file = /var/log/rsyncd.log
pid file = /var/run/rsyncd.pid
lock file = /var/run/rsyncd.lock
reverse lookup = no
[backup]
path = /data/backup/
comment = backup dir 
read only = no
auth users = rsyncuser
secrets file = /etc/rsync.pas


#服务器端准备目录
[root@backup-server ~]# mkdir -pv /data/backup
#服务器端生成验证文件
[root@backup-server ~]# echo "rsyncuser:123456" > /etc/rsync.pas
[root@backup-server ~]# chmod 600 /etc/rsync.pas
#服务器端启动rsync服务
[root@backup-server ~]# rsync --daemon #可加入/etc/rc.d/rc.local实现开
机启动
[root@backup-server ~]# systemctl restart rsyncd #CentOS 7 以上版本

#客户端配置密码文件
#也可将密码赋值给环境变量RSYNC_PASSWORD变量,但不安全
#export RSYNC_PASSWORD=123456
[root@backup-server ~]# echo "123456" > /etc/rsync.pas
[root@backup-server ~]# chmod 600 /etc/rsync.pas #此为必要项,权限必须修改
#查看远程rsync服务器的模块信息
[root@data-server ~]#rsync rsync://192.168.188.88
[root@data-server ~]#rsync rsync://192.168.188.88
backup         	backup dir


#交互式验证查看具体模块内的文件
[root@data-server ~]#rsync rsync://rsyncuser@192.168.188.88/backup
Password:
#非交互式查看共享目录
[root@data-server ~]#rsync --password-file=/etc/rsync.pas
rsync://rsyncuser@192.168.188.88/backup

#客户端测试同步数据
[root@data-server ~]#rsync -avz --delete --password-file=/etc/rsync.pas /data/www/ rsyncuser@192.168.188.88::backup
[root@data-server ~]#rsync -avz --delete --password-file=/etc/rsync.pas
rsyncuser@192.168.188.88::backup /data/www/

# 编写inotify+rsync+shell 脚本实现实时数据同步
[root@data-server ~]#vim inotify_rsync.sh 
#!/bin/bash
#
#********************************************************************
#Author:            dingbaohang
#QQ:                904748581
#Date:              2023-08-24
#FileName：         inotify_rsync.sh
#URL:               www.dingbh.top
#Description：      The test script
#Copyright (C):     2023 All rights reserved
#********************************************************************
#!/bin/bash
SRC='/data/www/'
DEST='rsyncuser@192.168.188.88::backup'
rpm -q inotify-tools &> /dev/null ||yum -y install inotify-tools
rpm -q rsync &> /dev/null || yum -y install rsync
inotifywait -mrq --exclude=".*\.swp" --timefmt '%Y-%m-%d %H:%M:%S' --format '%T %w %f' -e create,delete,moved_to,close_write,attrib ${SRC} |while read DATE TIME DIR FILE;do
    FILEPATH=${DIR}${FILE}
    rsync -az --delete --password-file=/etc/rsync.pas $SRC $DEST && echo "At ${TIME} on ${DATE}, file $FILEPATH was backuped up via rsync" >> /var/log/changelist.log
done
~       
	
[root@data-server ~]#nohup bash inotify_rsync.sh 
nohup: ignoring input and appending output to 'nohup.out'
#查看文件传输日志
[root@data-server ~]#tail -f /var/log/changelist.log
At 17:25:52 on 2023-08-26, file /data/www/a.txt was backuped up via rsync
At 17:25:52 on 2023-08-26, file /data/www/a.txt was backuped up via rsync
At 17:26:06 on 2023-08-26, file /data/www/d.txt was backuped up via rsync
At 17:26:06 on 2023-08-26, file /data/www/d.txt was backuped up via rsync
At 17:26:06 on 2023-08-26, file /data/www/d.txt was backuped up via rsync
At 18:30:38 on 2023-08-26, file /data/www/b.txt was backuped up via rsync
At 18:33:42 on 2023-08-26, file /data/www/c.txt was backuped up via rsync
At 18:34:08 on 2023-08-26, file /data/www/c.txt was backuped up via rsync
At 18:34:08 on 2023-08-26, file /data/www/c.txt was backuped up via rsync
At 18:34:08 on 2023-08-26, file /data/www/c.txt was backuped up via rsync
```

## 4.4、sersync的配置

```shell
echo 'PATH=/usr/local/sersync:$PATH' > /etc/profile.d/sersync.sh

#在数据服务器上下载sersync，并拷贝至相应的目录，设置PATH变量
[root@data-server ~]#wget https://storage.googleapis.com/google-code-archivedownloads/v2/code.google.com/sersync/sersync2.5.4_64bit_binary_stable_final.tar.
gz
[root@data-server ~]#tar -xf sersync2.5.4_64bit_binary_stable_final.tar.gz 
[root@data-server ~]#cp -a GNU-Linux-x86 /usr/local/sersync

[root@data-server ~]#cd GNU-Linux-x86/
#查看帮助
[root@data-server GNU-Linux-x86]#./sersync2 -h
set the system param
execute：echo 50000000 > /proc/sys/fs/inotify/max_user_watches
execute：echo 327679 > /proc/sys/fs/inotify/max_queued_events
parse the command param
_______________________________________________________
参数-d:启用守护进程模式
参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍
c参数-n: 指定开启守护线程的数量，默认为10个
参数-o:指定配置文件，默认使用confxml.xml文件
参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块
参数-m:单独启用其他模块，使用 -m socket 开启socket模块
参数-m:单独启用其他模块，使用 -m http 开启http模块
不加-m参数，则默认执行同步程序
________________________________________________________________
[root@data-server GNU-Linux-x86]#./sersync2 -dro /usr/local/sersync/confxml.xml
set the system param
execute：echo 50000000 > /proc/sys/fs/inotify/max_user_watches
execute：echo 327679 > /proc/sys/fs/inotify/max_queued_events
parse the command param
option: -d 	run as a daemon
option: -r 	rsync all the local files to the remote servers before the sersync work
option: -o 	config xml name：  /usr/local/sersync/confxml.xml
daemon thread num: 10
parse xml config file
host ip : localhost	host port: 8008
daemon start，sersync run behind the console 
use rsync password-file :
user is	rsyncuser
passwordfile is 	/etc/rsync.pas
config xml parse success
please set /etc/rsyncd.conf max connections=0 Manually
sersync working thread 12  = 1(primary thread) + 1(fail retry thread) + 10(daemon sub threads) 
Max threads numbers is: 22 = 12(Thread pool nums) + 10(Sub threads)
please according your cpu ，use -n param to adjust the cpu rate
------------------------------------------
rsync the directory recursivly to the remote servers once
working please wait...
execute command: cd /data/www && rsync -artuz -R --delete ./ rsyncuser@192.168.188.88::backup --password-file=/etc/rsync.pas >/dev/null 2>&1 
run the sersync: 
watch path is: /data/www
[root@data-server GNU-Linux-x86]#ss -ntl
State               Recv-Q              Send-Q                           Local Address:Port                            Peer Address:Port              Process              
LISTEN              0                   128                                    0.0.0.0:20048                                0.0.0.0:*                                      
LISTEN              0                   64                                     0.0.0.0:23443                                0.0.0.0:*                                      
LISTEN              0                   10                                  172.30.0.1:53                                   0.0.0.0:*                                      
LISTEN              0                   10                               192.168.188.8:53                                   0.0.0.0:*                                      
LISTEN              0                   10                                    10.8.0.1:53                                   0.0.0.0:*                                      
LISTEN              0                   10                                   127.0.0.1:53                                   0.0.0.0:*                                      
LISTEN              0                   128                                    0.0.0.0:22                                   0.0.0.0:*                                      
LISTEN              0                   100                                  127.0.0.1:25                                   0.0.0.0:*                                      
LISTEN              0                   128                                  127.0.0.1:953                                  0.0.0.0:*                                      
LISTEN              0                   128                                    0.0.0.0:38077                                0.0.0.0:*                                      
LISTEN              0                   64                                     0.0.0.0:2049                                 0.0.0.0:*                                      
LISTEN              0                   32                                     0.0.0.0:1194                                 0.0.0.0:*                                      
LISTEN              0                   128                                    0.0.0.0:111                                  0.0.0.0:*                                      
LISTEN              0                   128                                       [::]:20048                                   [::]:*                                      
LISTEN              0                   64                                        [::]:33201                                   [::]:*                                      
LISTEN              0                   10                                       [::1]:53                                      [::]:*                                      
LISTEN              0                   128                                       [::]:22                                      [::]:*                                      
LISTEN              0                   100                                      [::1]:25                                      [::]:*                                      
LISTEN              0                   128                                      [::1]:953                                     [::]:*                                      
LISTEN              0                   128                                       [::]:36479                                   [::]:*                                      
LISTEN              0                   64                                        [::]:2049                                    [::]:*                                      
LISTEN              0                   128                                          *:9090                                       *:*                                      
LISTEN              0                   128                                       [::]:111                                     [::]:*                                      

[root@data-server GNU-Linux-x86]#cp /etc/shadow /data/www/
[root@data-server GNU-Linux-x86]#chown ding /data/www/shadow 
[root@data-server GNU-Linux-x86]#id ding
uid=1000(ding) gid=1003(ding) groups=1003(ding)

[root@data-server GNU-Linux-x86]#mv /data/www/shadow /data/www/ding.txt


#验证
数据主机：
[root@data-server GNU-Linux-x86]#ls /data/www/ -l
total 4
---------- 1 ding root 1149 Aug 26 20:27 ding.txt
备份主机：
[root@backup-server ~]# ls -l /data/backup/
total 4
---------- 1 1000 root 1149 Aug 26  2023 ding.txt
```

# 5、实现基于分布式的LAMP架构，并将NFS实时同步到备份服务器

```shell
[root@Rocky8 ~]# yum -y install httpd php php-mysqlnd php-json；systemctl enable --now httpd
[root@Rocky8 ~]#  wget   wordpress-6.2.2-zh_CN.zip
[root@Rocky8 ~]#ls
anaconda-ks.cfg  date.txt.bak  reset2.sh  reset.sh  wordpress-6.2.2-zh_CN.zip
[root@Rocky8 ~]# unzip wordpress-6.2.2-zh_CN.zip 
[root@Rocky8 ~]#ls
anaconda-ks.cfg  date.txt.bak  reset2.sh  reset.sh  wordpress  wordpress-6.2.2-zh_CN.zip
[root@Rocky8 ~]# mv wordpress/* /var/www/html/
chown apache.apache /var/www/html/ -R
#配置数据库
[root@Rocky8 ~]#yum -y install mysql-server
[root@Rocky8 ~]#systemctl enable --now mysqld
Created symlink /etc/systemd/system/multi-user.target.wants/mysqld.service → /usr/lib/systemd/system/mysqld.service.

[root@Rocky8 ~]#mysql
mysql> create user wordpress@'192.168.188.%' identified by '123456';
Query OK, 0 rows affected (0.01 sec)

mysql> create database wordpress;
Query OK, 1 row affected (0.00 sec)

mysql> grant all on wordpress.* to wordpress@'192.168.188.%';
Query OK, 0 rows affected (0.01 sec)

#访问http：//192.168.188.82

#主机192.168.188.7配置dns服务
[root@centos7 ~]#vim install_dns.sh 
#!/bin/bash

DOMAIN=dingbh.top
HOST=www
HOST_IP=192.168.188.81

CPUS=`lscpu |awk '/^CPU\(s\)/{print $2}'`
. /etc/os-release

color () {
    RES_COL=60
    MOVE_TO_COL="echo -en \\033[${RES_COL}G"
    SETCOLOR_SUCCESS="echo -en \\033[1;32m"
    SETCOLOR_FAILURE="echo -en \\033[1;31m"
    SETCOLOR_WARNING="echo -en \\033[1;33m"
    SETCOLOR_NORMAL="echo -en \E[0m"
    echo -n "$1" && $MOVE_TO_COL
    echo -n "["
    if [ $2 = "success" -o $2 = "0" ] ;then
        ${SETCOLOR_SUCCESS}
        echo -n $"  OK  "    
    elif [ $2 = "failure" -o $2 = "1"  ] ;then 
        ${SETCOLOR_FAILURE}
        echo -n $"FAILED"
    else
        ${SETCOLOR_WARNING}
        echo -n $"WARNING"
    fi
    ${SETCOLOR_NORMAL}
    echo -n "]"
    echo 
}


install_dns () {
    if [ $ID = 'centos' -o $ID = 'rocky' ];then
	    yum install -y  bind bind-utils
	elif [ $ID = 'ubuntu' ];then
        color "不支持Ubuntu操作系统，退出!" 1
        exit
	    #apt update
	    #apt install -y  bind9 bind9-utils
	else
	    color "不支持此操作系统，退出!" 1
	    exit
	fi
    
}

config_dns () {
    sed -i -e '/listen-on/s/127.0.0.1/localhost/' -e '/allow-query/s/localhost/any/' /etc/named.conf
    cat >> 	/etc/named.rfc1912.zones <<EOF
zone "$DOMAIN" IN {
    type master;
    file  "$DOMAIN.zone";
};
EOF
   cat > /var/named/$DOMAIN.zone <<EOF
\$TTL 1D
@	IN SOA	master admin (
					1	; serial
					1D	; refresh
					1H	; retry
					1W	; expire
					3H )	; minimum
	        NS	 master
master      A    `hostname -I`         
$HOST     	A    $HOST_IP
EOF
   chmod 640 /var/named/$DOMAIN.zone
   chgrp named /var/named/$DOMAIN.zone
}

start_service () {
    systemctl enable --now named
	systemctl is-active named.service
	if [ $? -eq 0 ] ;then 
        color "DNS 服务安装成功!" 0  
    else 
        color "DNS 服务安装失败!" 1
        exit 1
    fi   
}

install_dns
config_dns
start_service


[root@centos7 ~]#bash install_dns.sh
[root@centos7 ~]# rndc reload  #生效dns配置
#验证dns配置
[root@centos7 ~]#dig www.dingbh.top @127.0.0.1

#配置web2
[root@Rocky8 ~]#yum -y install httpd php php-mysqlnd php-json
[root@Rocky8 ~]#systemctl enable --now httpd
[root@Rocky8 ~]#scp -r /var/www/html/wp-content/uploads/2023/ 192.168.188.82:/data/www


#dns配置192.168.188.83
[root@centos7 ~]#vim /var/named/dingbh.top.zone
$TTL 1D
@   IN SOA  master admin (
                    1   ; serial
                    1D  ; refresh
                    1H  ; retry
                    1W  ; expire
                    3H )    ; minimum
            NS   master
master      A    192.168.188.7    
www         A    192.168.188.81
www         A    192.168.188.83    #添加192.168.188.83主机

[root@centos7 ~]# rndc reload  #生效dns配置
[root@centos7 ~]#dig www.dingbh.top @127.0.0.1

#访问www.dingbh.top验证


##创建rsync服务器192.168.188.84
[root@backup-server ~]#yum -y  install rsync-daemon.noarch
[root@backup-server ~]#vim /etc/rsyncd.conf
uid = root
gid = root
max connections = 0 
ignore errors
exclude = lost+found/
log file = /var/log/rsyncd.log
pid file = /var/run/rsyncd.pid
lock file = /var/run/rsyncd.lock
reverse lookup = no
[backup]
path = /data/backup/
comment = backup dir 
read only = no
auth users = rsyncuser
secrets file = /etc/rsync.pas

#创建rsync配置附加密码文件
[root@backup-server ~]#touch /etc/rsync.pas
[root@backup-server ~]#echo "rsyncuer:123456" > /etc/rsync.pas
[root@backup-server ~]#chmod 600 /etc/rsync.pas
[root@backup-server ~]#rsync --daemon
[root@backup-server ~]#systemctl enable --now rsyncd
Created symlink /etc/systemd/system/multi-user.target.wants/rsyncd.service → /usr/lib/systemd/system/rsyncd.service.

[root@backup-server ~]#mkdir -pv  /data/backup/
mkdir: created directory '/data'
mkdir: created directory '/data/backup/'

#数据data-server服务器192.168.188.82配置
[root@Rocky8 ~]#echo "123456" > /etc/rsync.pas
[root@Rocky8 ~]#chmod 600 /etc/rsync.pas 
[root@Rocky8 ~]#rsync rsync://192.168.188.84
backup         	backup dir
#验证并同步数据
[root@Rocky8 ~]#rsync -avz --delete --password-file=/etc/rsync.pas /data/www/ rsyncuser@192.168.188.84::backup
sending incremental file list
./
2023/
2023/08/
2023/08/2022-03-21-3.png
2023/08/20220326212812.png
2023/08/20220326213543.png
2023/08/QQ图片20210401184037.jpg
2023/08/屏幕截图-2023-05-15-163131.png
elementor/
elementor/css/
elementor/css/post-14.css

sent 3,026,200 bytes  received 153 bytes  6,052,706.00 bytes/sec
total size is 3,024,291  speedup is 1.00


# inotify+rsync+shell 脚本实现实时数据同步
[root@Rocky8 ~]#vim inotify_rsync.sh
[root@Rocky8 ~]#cat inotify_rsync.sh
SRC='/data/www/'
DEST='rsyncuser@192.168.188.84::backup'
rpm -q inotify-tools &> /dev/null ||yum -y install inotify-tools
rpm -q rsync &> /dev/null || yum -y install rsync
inotifywait -mrq --exclude=".*\.swp" --timefmt '%Y-%m-%d %H:%M:%S' --format '%T %w %f' -e create,delete,moved_to,close_write,attrib ${SRC} |while read DATE TIME DIR FILE;do
    FILEPATH=${DIR}${FILE}
    rsync -az --delete --password-file=/etc/rsync.pas $SRC $DEST && echo "At ${TIME} on ${DATE}, file $FILEPATH was backuped up via rsync" >> /var/log/changelist.log
done


#rsync服务器验证
data服务器验证192.168.188.82
[root@data-server ~]#tree /data/www/
/data/www/
├── 2023
│   └── 08
│       ├── 2020-07-22-2-1.png
│       ├── 2020-07-22-2.png
│       ├── 2022-03-21-3.png
│       ├── 20220326212812.png
│       ├── 20220326213543.png
│       ├── QQ图片20210401184037.jpg
│       ├── 屏幕截图-2023-03-29-110411.png
│       └── 屏幕截图-2023-05-15-163131.png
└── elementor
    └── css
        └── post-14.css

4 directories, 9 files

[root@backup-server ~]#tree /data/backup/
/data/backup/
├── 2023
│   └── 08
│       ├── 2020-07-22-2.png
│       ├── 2022-03-21-3.png
│       ├── 20220326212812.png
│       ├── 20220326213543.png
│       ├── QQ图片20210401184037.jpg
│       ├── 屏幕截图-2023-03-29-110411.png
│       └── 屏幕截图-2023-05-15-163131.png
└── elementor
    └── css
        └── post-14.css

4 directories, 8 files

```

rsync-client自动化脚本

```
echo "123456" > /etc/rsync.pas
chmod 600 /etc/rsync.pas

cat >> inotify_rsync.sh <<EOF
#!/bin/bash
SRC='/data/www/'
DEST='rsyncuser@192.168.188.84::backup'
rpm -q inotify-tools &> /dev/null ||yum -y install inotify-tools
rpm -q rsync &> /dev/null || yum -y install rsync
inotifywait -mrq --exclude=".*\.swp" --timefmt '%Y-%m-%d %H:%M:%S' --format '%T %w %f' -e create,delete,moved_to,close_write,attrib ${SRC} |while read DATE TIME DIR FILE;do
    FILEPATH=${DIR}${FILE}
    rsync -az --delete --password-file=/etc/rsync.pas $SRC $DEST && echo "At ${TIME} on ${DATE}, file $FILEPATH was backuped up via rsync" >> /var/log/changelist.log
done
EOF

nohup bash inotify_rsync.sh
```

